---
date: 2017-07-19T00:00:00+09:00
title: JSONをGolangのstructに変換する
tags: ["golang"]
---

先日の[golang.tokyo #7](https://techplay.jp/event/624712)で自社パッケージの紹介LT大会にてLTでjson2structと言うパッケージの紹介をさせていただきました。

<iframe src="../../slides/json2struct" title="JSONをGolangのstructに変換する" class="slide" scrolling="no" frameborder="0"></iframe>
[スライドURL](../../slides/json2struct)


細かい使い方や既存の同様のツールとの差異について書いていきたいと思います。


## ツールの概要

GolangではJSONからデータを取得する際にあらかじめstructの定義をしておくことがありますが、その際に下記のようにタグ等など設定しなくてはならず、手間がかかってしまうのが面倒くさい。
また外部のAPI等でJSONの形式が複雑な場合その定義はより手間がかかってしまう。

```json
{"url": "http://blog.yudppp.com", "text": "Hello:)", "status": 1}
```

```go
type Blog struct {
	Status int    `json:"status"`
	Text   string `json:"text"`
	URL    string `json:"url"`
}
```

それらを解決するために、JSONからGolangのstructの形式に変換するツールは幾つか既に存在しています・。

- [json-to-go](https://mholt.github.io/json-to-go/)
- [gojson](https://github.com/ChimeraCoder/gojson)

私はこれらのツールを使っていたのですが、実際に使う際に使いにくいポイントがあったので自分で作成しました。

### json-to-go

json-to-goはサイト上でJSONをstructに変換してくれるツールです。

https://mholt.github.io/json-to-go/

こちらの実行結果を見ていくと普段自分が書かないstructのnestや[]structといったものができてしまい、個人的には実用的でないと判断し使うことをやめました。

またJavaScript製でgofmtがされていないものが出力されます。

input
```json
{"url": "http://blog.yudppp.com", "text": "Hello:)", "status": 1, "categories": [{"name": "golang"}]}
```

output
```go
type AutoGenerated struct {
	URL string `json:"url"`
	Text string `json:"text"`
	Status int `json:"status"`
	Categories []struct {
		Name string `json:"name"`
	} `json:"categories"`
}
```

### gojson

https://github.com/ChimeraCoder/gojson

gojsonも同様のツールでcliを用いて、JSONのinputに対してstructを吐き出します。defaultではstructがnestするのですが、`-subStruct`のオプションを設定することによって別のstructに分けることができます。

ただし生成されるサブストラクト名が`Blog_sub1`という名前でこのまま使いたくなくrenameする必要がありました。

```plain
$ echo '{"url": "http://blog.yudppp.com", "text": "Hello:)", "status": 1, "categories": [{"name": "golang"}]}' \
| gojson -name Blog
```
```go
package main

type Blog struct {
	Categories []struct {
		Name string `json:"name"`
	} `json:"categories"`
	Status int64  `json:"status"`
	Text   string `json:"text"`
	URL    string `json:"url"`
}
```
```plain
$ echo '{"url": "http://blog.yudppp.com", "text": "Hello:)", "status": 1, "categories": [{"name": "golang"}]}' \
| gojson -name Blog -subStruct
```
```go
package main

type Blog struct {
	Categories []Blog_sub1 `json:"categories"`
	Status     int64       `json:"status"`
	Text       string      `json:"text"`
	URL        string      `json:"url"`
}

type Blog_sub1 struct {
	Name string `json:"name"`
}
```

またWeb上で確認できるものがなく、CLIで確認する方法しかありませんでした。

### json2struct

これらを受けて[json2struct](https://github.com/yudppp/json2struct)を作成しました。

まず[CLI](https://github.com/yudppp/json2struct)と[Web](https://yudppp.github.io/json2struct/)の2種類の方法で扱うことができます。

json2structを使うと先ほどのJSONが下記のようになります


```plain
$ echo '{"url": "http://blog.yudppp.com", "text": "Hello:)", "status": 1, "categories": [{"name": "golang"}]}' \
| json2struct -name Blog
```
```go
type Blog struct {
	Categories []BlogCategory `json:"categories"`
	Status     int            `json:"status"`
	Text       string         `json:"text"`
	URL        string         `json:"url"`
}

type BlogCategory struct {
	Name string `json:"name"`
}
```

gojsonでは`Blog_sub1`だったものが`BlogCategory`に変わっています。
こちらでポイントなのがプロパティ名が`Categories`と複数形だったものを配列だったので単数形に`Category`と変換したものともとのstruct名である`Blog`と足しあわせて`BlogCategory`としています。(外部のパッケージ使っただけですが)

またサブストラクトの命名をオプションで色々変更ができるようにしていて、元のstruct名を引き継ぐのが冗長的で嫌いという人には`-short`のOptionをつけると`Category`というstruct名になったり、suffixにResponseをつけたいというのであれば`-suffix Response`とするとそれぞれ`BlogResponse`,`BlogCategoryResponse`となるようになります。

細かなOptionについては下記のようになっています。
最新は[README](https://github.com/yudppp/json2struct/blob/master/README.md)を参照してください。

| option | description |
|:-----------|:-----------|
| name | メインのストラクト名を指定する |
| prefix | ストラクトのprefixを指定する |
| suffix | ストラクトのsuffixを指定する |
| short | サブストラクトの命名を簡易にする |
| local | local変数にする|
| omitempty | omitemptyのオプションをつける |
| example | [example tag](https://github.com/yudppp/structs)をつける(後述します) |

欲しいオプション等ありましたら気軽に実装していきたいと思いますのでissueとかに書いていただけたらと思います。

#### playgroundについて

[こちら](https://yudppp.github.io/json2struct/)で簡単にWeb上でjson2structを利用することができます。
またオプションの値をWeb上で変えられるので出力結果を見ながらオプションの変更をすることができます。

技術的には[GopherJS](https://github.com/gopherjs/gopherjs)と[vecty](https://github.com/gopherjs/vecty)を使っています。
GopherJSはGoで書かれたコードをJavaScriptに変換してくれるもので、vectyは語弊があるかもしれませんが簡単に言うとGopherJSをReact風にかけるもので、これにより簡単にGopherJSを導入することができました。


#### example tagについて

`-example`をつけるとexampleタグが自動でつくようになります。
このexampleタグを利用するとJSONのサンプルの値を簡単に入れれるようになります。(完全に元のJSONに戻るもので現状ありません(配列の扱いが辛い))

```go
package main
import (
    "fmt"

    "github.com/yudppp/structs"
)

type Blog struct {
	Categories []BlogCategory `json:"categories"`
	Status     int            `json:"status" example:"1"`
	Text       string         `json:"text" example:"Hello:)"`
	URL        string         `json:"url" example:"http://blog.yudppp.com"`
}

type BlogCategory struct {
	Name string `json:"name" example:"golang"`
}

func main() {
    blog := structs.NewExample(Blog{}).(Blog)
    fmt.Println(blog.Text) # -> Hello:)
    fmt.Println(blog.Categories[0].Name) # -> golang
}
```

このように簡単にサンプル用の値を入れることができるのでテストや開発時のモックAPI、ドキュメント作成時に利用していければと思っています。

## まとめ

ストラクトを分けたくてストラクト名をいい感じにしたいならjson2structがオススメです。

`絶賛リファクタリング中なのでCLIのインターフェースは変えないが中身が雑すぎて恥ずかしいので絶対に見ないでほしい。`は引き続きお願いします。[[Github](https://github.com/yudppp/json2struct)]

## 将来直したいこと

- プロパティ名がアルファベット順になっているので元のJSONの順番になるように合わせたい
- GopherJSでクリップボードにコピーしたい
- example tagを完璧に元のJSONに戻せるようにしたい。
- 出力されるstruct名が被ってしまう場合があるのでその時の対処を考える。(Imageストラクトがいろんなストラクトに含まれている場合など)
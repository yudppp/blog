<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VOdSVFLZgu5oX1fWGwT5OkE9QF-b6k3XMEZIkFIuiTA" />

<title>JSONをGolangのstructに変換する - ◯ △ □</title>

<link rel="icon" href="https://blog.yudppp.com/img/favicon.png">
<link rel="shortcut icon" href="https://blog.yudppp.com/img/favicon.png">
<link rel="stylesheet" href="https://blog.yudppp.com/css/lib.min.css">
<link rel="stylesheet" href="https://blog.yudppp.com/css/app.min.css">
<link rel="alternate" href="https://blog.yudppp.com/index.xml" title="" type="application/rss+xml">

<meta property="og:type", content="article">
<meta property="og:url", content="https://blog.yudppp.com/posts/json2struct/">
<meta property="og:site_name", content="◯ △ □">
<meta property="og:title", content="JSONをGolangのstructに変換する">


  <meta name="description" content="先日のgolang.tokyo #7で自社パッケージの紹介LT大会にてLTでjson2structと言うパッケージの紹介をさせていただきました。
 スライドURL
細かい使い方や既存の同様のツールとの差異について書いていきたいと思います。
ツールの概要 GolangではJSONからデータを取得する際にあらかじめstructの定義をしておくことがありますが、その際に下記のようにタグ等など設定しなくてはならず、手間がかかってしまうのが面倒くさい。 また外部のAPI等でJSONの形式が複雑な場合その定義はより手間がかかってしまう。
{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1}  type Blog struct { Status int `json:&quot;status&quot;` Text string `json:&quot;text&quot;` URL string `json:&quot;url&quot;` }  それらを解決するために、JSONからGolangのstructの形式に変換するツールは幾つか既に存在しています・。
 json-to-go gojson  私はこれらのツールを使っていたのですが、実際に使う際に使いにくいポイントがあったので自分で作成しました。
json-to-go json-to-goはサイト上でJSONをstructに変換してくれるツールです。
https://mholt.github.io/json-to-go/
こちらの実行結果を見ていくと普段自分が書かないstructのnestや[]structといったものができてしまい、個人的には実用的でないと判断し使うことをやめました。
またJavaScript製でgofmtがされていないものが出力されます。
input
{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1, &quot;categories&quot;: [{&quot;name&quot;: &quot;golang&quot;}]}  output
type AutoGenerated struct { URL string `json:&quot;url&quot;` Text string `json:&quot;text&quot;` Status int `json:&quot;status&quot;` Categories []struct { Name string `json:&quot;name&quot;` } `json:&quot;categories&quot;` }  gojson https://github.">


  </head>
  <body class="hack">
    <header>
  <div class="container">
    
    <div class="nav">
      <div class="nav__left">
        <span class="nav__item">
          <a class="nocolor" href="https://blog.yudppp.com">
            <canvas class="mini-logo" width="150" height="50">
          </a>
        </span>
      </div>
    </div>
    <div class="title">
      <h1>JSONをGolangのstructに変換する</h1>
    </div>
    
  </div>
</header>

    <main>
      <div class="container">
        <date>2017.07.19</date>
        <div class="content">
          

<p>先日の<a href="https://techplay.jp/event/624712">golang.tokyo #7</a>で自社パッケージの紹介LT大会にてLTでjson2structと言うパッケージの紹介をさせていただきました。</p>

<p><iframe src="../../slides/json2struct" title="JSONをGolangのstructに変換する" class="slide" scrolling="no" frameborder="0"></iframe>
<a href="../../slides/json2struct">スライドURL</a></p>

<p>細かい使い方や既存の同様のツールとの差異について書いていきたいと思います。</p>

<h2 id="ツールの概要">ツールの概要</h2>

<p>GolangではJSONからデータを取得する際にあらかじめstructの定義をしておくことがありますが、その際に下記のようにタグ等など設定しなくてはならず、手間がかかってしまうのが面倒くさい。
また外部のAPI等でJSONの形式が複雑な場合その定義はより手間がかかってしまう。</p>

<pre><code class="language-json">{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1}
</code></pre>

<pre><code class="language-go">type Blog struct {
	Status int    `json:&quot;status&quot;`
	Text   string `json:&quot;text&quot;`
	URL    string `json:&quot;url&quot;`
}
</code></pre>

<p>それらを解決するために、JSONからGolangのstructの形式に変換するツールは幾つか既に存在しています・。</p>

<ul>
<li><a href="https://mholt.github.io/json-to-go/">json-to-go</a></li>
<li><a href="https://github.com/ChimeraCoder/gojson">gojson</a></li>
</ul>

<p>私はこれらのツールを使っていたのですが、実際に使う際に使いにくいポイントがあったので自分で作成しました。</p>

<h3 id="json-to-go">json-to-go</h3>

<p>json-to-goはサイト上でJSONをstructに変換してくれるツールです。</p>

<p><a href="https://mholt.github.io/json-to-go/">https://mholt.github.io/json-to-go/</a></p>

<p>こちらの実行結果を見ていくと普段自分が書かないstructのnestや[]structといったものができてしまい、個人的には実用的でないと判断し使うことをやめました。</p>

<p>またJavaScript製でgofmtがされていないものが出力されます。</p>

<p>input</p>

<pre><code class="language-json">{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1, &quot;categories&quot;: [{&quot;name&quot;: &quot;golang&quot;}]}
</code></pre>

<p>output</p>

<pre><code class="language-go">type AutoGenerated struct {
	URL string `json:&quot;url&quot;`
	Text string `json:&quot;text&quot;`
	Status int `json:&quot;status&quot;`
	Categories []struct {
		Name string `json:&quot;name&quot;`
	} `json:&quot;categories&quot;`
}
</code></pre>

<h3 id="gojson">gojson</h3>

<p><a href="https://github.com/ChimeraCoder/gojson">https://github.com/ChimeraCoder/gojson</a></p>

<p>gojsonも同様のツールでcliを用いて、JSONのinputに対してstructを吐き出します。defaultではstructがnestするのですが、<code>-subStruct</code>のオプションを設定することによって別のstructに分けることができます。</p>

<p>ただし生成されるサブストラクト名が<code>Blog_sub1</code>という名前でこのまま使いたくなくrenameする必要がありました。</p>

<pre><code class="language-plain">$ echo '{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1, &quot;categories&quot;: [{&quot;name&quot;: &quot;golang&quot;}]}' \
| gojson -name Blog
</code></pre>

<pre><code class="language-go">package main

type Blog struct {
	Categories []struct {
		Name string `json:&quot;name&quot;`
	} `json:&quot;categories&quot;`
	Status int64  `json:&quot;status&quot;`
	Text   string `json:&quot;text&quot;`
	URL    string `json:&quot;url&quot;`
}
</code></pre>

<pre><code class="language-plain">$ echo '{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1, &quot;categories&quot;: [{&quot;name&quot;: &quot;golang&quot;}]}' \
| gojson -name Blog -subStruct
</code></pre>

<pre><code class="language-go">package main

type Blog struct {
	Categories []Blog_sub1 `json:&quot;categories&quot;`
	Status     int64       `json:&quot;status&quot;`
	Text       string      `json:&quot;text&quot;`
	URL        string      `json:&quot;url&quot;`
}

type Blog_sub1 struct {
	Name string `json:&quot;name&quot;`
}
</code></pre>

<p>またWeb上で確認できるものがなく、CLIで確認する方法しかありませんでした。</p>

<h3 id="json2struct">json2struct</h3>

<p>これらを受けて<a href="https://github.com/yudppp/json2struct">json2struct</a>を作成しました。</p>

<p>まず<a href="https://github.com/yudppp/json2struct">CLI</a>と<a href="https://yudppp.github.io/json2struct/">Web</a>の2種類の方法で扱うことができます。</p>

<p>json2structを使うと先ほどのJSONが下記のようになります</p>

<pre><code class="language-plain">$ echo '{&quot;url&quot;: &quot;http://blog.yudppp.com&quot;, &quot;text&quot;: &quot;Hello:)&quot;, &quot;status&quot;: 1, &quot;categories&quot;: [{&quot;name&quot;: &quot;golang&quot;}]}' \
| json2struct -name Blog
</code></pre>

<pre><code class="language-go">type Blog struct {
	Categories []BlogCategory `json:&quot;categories&quot;`
	Status     int            `json:&quot;status&quot;`
	Text       string         `json:&quot;text&quot;`
	URL        string         `json:&quot;url&quot;`
}

type BlogCategory struct {
	Name string `json:&quot;name&quot;`
}
</code></pre>

<p>gojsonでは<code>Blog_sub1</code>だったものが<code>BlogCategory</code>に変わっています。
こちらでポイントなのがプロパティ名が<code>Categories</code>と複数形だったものを配列だったので単数形に<code>Category</code>と変換したものともとのstruct名である<code>Blog</code>と足しあわせて<code>BlogCategory</code>としています。(外部のパッケージ使っただけですが)</p>

<p>またサブストラクトの命名をオプションで色々変更ができるようにしていて、元のstruct名を引き継ぐのが冗長的で嫌いという人には<code>-short</code>のOptionをつけると<code>Category</code>というstruct名になったり、suffixにResponseをつけたいというのであれば<code>-suffix Response</code>とするとそれぞれ<code>BlogResponse</code>,<code>BlogCategoryResponse</code>となるようになります。</p>

<p>細かなOptionについては下記のようになっています。
最新は<a href="https://github.com/yudppp/json2struct/blob/master/README.md">README</a>を参照してください。</p>

<table>
<thead>
<tr>
<th align="left">option</th>
<th align="left">description</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">name</td>
<td align="left">メインのストラクト名を指定する</td>
</tr>

<tr>
<td align="left">prefix</td>
<td align="left">ストラクトのprefixを指定する</td>
</tr>

<tr>
<td align="left">suffix</td>
<td align="left">ストラクトのsuffixを指定する</td>
</tr>

<tr>
<td align="left">short</td>
<td align="left">サブストラクトの命名を簡易にする</td>
</tr>

<tr>
<td align="left">local</td>
<td align="left">local変数にする</td>
</tr>

<tr>
<td align="left">omitempty</td>
<td align="left">omitemptyのオプションをつける</td>
</tr>

<tr>
<td align="left">example</td>
<td align="left"><a href="https://github.com/yudppp/structs">example tag</a>をつける(後述します)</td>
</tr>
</tbody>
</table>

<p>欲しいオプション等ありましたら気軽に実装していきたいと思いますのでissueとかに書いていただけたらと思います。</p>

<h4 id="playgroundについて">playgroundについて</h4>

<p><a href="https://yudppp.github.io/json2struct/">こちら</a>で簡単にWeb上でjson2structを利用することができます。
またオプションの値をWeb上で変えられるので出力結果を見ながらオプションの変更をすることができます。</p>

<p>技術的には<a href="https://github.com/gopherjs/gopherjs">GopherJS</a>と<a href="https://github.com/gopherjs/vecty">vecty</a>を使っています。
GopherJSはGoで書かれたコードをJavaScriptに変換してくれるもので、vectyは語弊があるかもしれませんが簡単に言うとGopherJSをReact風にかけるもので、これにより簡単にGopherJSを導入することができました。</p>

<h4 id="example-tagについて">example tagについて</h4>

<p><code>-example</code>をつけるとexampleタグが自動でつくようになります。
このexampleタグを利用するとJSONのサンプルの値を簡単に入れれるようになります。(完全に元のJSONに戻るもので現状ありません(配列の扱いが辛い))</p>

<pre><code class="language-go">package main
import (
    &quot;fmt&quot;

    &quot;github.com/yudppp/structs&quot;
)

type Blog struct {
	Categories []BlogCategory `json:&quot;categories&quot;`
	Status     int            `json:&quot;status&quot; example:&quot;1&quot;`
	Text       string         `json:&quot;text&quot; example:&quot;Hello:)&quot;`
	URL        string         `json:&quot;url&quot; example:&quot;http://blog.yudppp.com&quot;`
}

type BlogCategory struct {
	Name string `json:&quot;name&quot; example:&quot;golang&quot;`
}

func main() {
    blog := structs.NewExample(Blog{}).(Blog)
    fmt.Println(blog.Text) # -&gt; Hello:)
    fmt.Println(blog.Categories[0].Name) # -&gt; golang
}
</code></pre>

<p>このように簡単にサンプル用の値を入れることができるのでテストや開発時のモックAPI、ドキュメント作成時に利用していければと思っています。</p>

<h2 id="まとめ">まとめ</h2>

<p>ストラクトを分けたくてストラクト名をいい感じにしたいならjson2structがオススメです。</p>

<p><code>絶賛リファクタリング中なのでCLIのインターフェースは変えないが中身が雑すぎて恥ずかしいので絶対に見ないでほしい。</code>は引き続きお願いします。[<a href="https://github.com/yudppp/json2struct">Github</a>]</p>

<h2 id="将来直したいこと">将来直したいこと</h2>

<ul>
<li>プロパティ名がアルファベット順になっているので元のJSONの順番になるように合わせたい</li>
<li>GopherJSでクリップボードにコピーしたい</li>
<li>example tagを完璧に元のJSONに戻せるようにしたい。</li>
<li>出力されるstruct名が被ってしまう場合があるのでその時の対処を考える。(Imageストラクトがいろんなストラクトに含まれている場合など)</li>
</ul>

          <a href="https://twitter.com/share" class="twitter-share-button" data-via="yudppp">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
          <div class="comment">
    <div>
        <a id="js-open-comment" class="event">
            show comment <span class="disqus-comment-count" data-disqus-url="https://blog.yudppp.com/posts/json2struct/"></span>
        </a>
    </div>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
     
     
    var openDiqus = function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//yudppp.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    document.all("js-open-comment").style.display = "none";
    };
    document.getElementById("js-open-comment").addEventListener('click',openDiqus,false);
</script>
        </div>
      </div>
    </main>
    
<div class="container">
	<div class="prevnext">
		
		<a class="pull-left" href="https://blog.yudppp.com/posts/kubejobremover/">
			<div>&lt;&lt; Kubernetesの成功したJobを消す</div>
		</a>
		
		
		<a class="pull-right" href="https://blog.yudppp.com/posts/golang_time_format/">
			<div>Go言語の忘れがちなtime fomatの話 &gt;&gt;</div>
		</a>
		
	</div>
</div>

    <div class="container">
  <a href="https://blog.yudppp.com/posts/whoami/">
    <div class="media profile">
      <div class="media-left">
        <img class="avatarholder" src="https://blog.yudppp.com/img/profile.svg" />
      </div>
      <div class="media-body">
        <div class="media-heading">@yudppp</div>
        <div class="media-content">Web engineer.</div>
      </div>
    </div>
  </a>
</div>

    <script src="https://blog.yudppp.com/js/lib.min.js"></script>
<script src="https://blog.yudppp.com/js/app.min.js"></script>
<script id="dsq-count-scr" src="//yudppp.disqus.com/count.js" async></script>
  </body>
</html>

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="VOdSVFLZgu5oX1fWGwT5OkE9QF-b6k3XMEZIkFIuiTA" />

<title>ISUCON8の予選で敗戦した話と感想戦で1位の点数を超えるまで頑張った話 - ◯ △ □</title>

<link rel="icon" href="https://blog.yudppp.com/img/favicon.png">
<link rel="shortcut icon" href="https://blog.yudppp.com/img/favicon.png">
<link rel="stylesheet" href="https://blog.yudppp.com/css/lib.min.css">
<link rel="stylesheet" href="https://blog.yudppp.com/css/app.min.css">
<link rel="alternate" href="https://blog.yudppp.com/index.xml" title="" type="application/rss+xml">

<meta property="og:type", content="article">
<meta property="og:url", content="https://blog.yudppp.com/posts/isucon2018/">
<meta property="og:site_name", content="◯ △ □">
<meta property="og:title", content="ISUCON8の予選で敗戦した話と感想戦で1位の点数を超えるまで頑張った話">


  <meta name="description" content="当日 ISUCON8の予選に参加しました。ISUCON4から参加しているので5回目ですが、一度も決勝行けてないので辛いです。
今年もいつものメンバーで参加の予定だったのですが体調不良によって2人での参加になりました。
自分は当日メインでアプリを触りやったことのは
 User周りの不要なQuery削除 Sheetをオンメモリーにもつ 1000N &#43; 1 だった getEvents を一旦 N &#43; 1 に修正 reservationsにuser_id_idxを追加 getEventSimpleというsheet情報だけをとるように一部切り替え  この辺りを行い最高で19,787となりのあと1時間だったので夢を見たのですが、その後Failが続き色々検証しているうちに終了となりました。
reservationにRedisを使おうという考えもあったのですが時間考えると乗り出せませんでした。
今年のISUCON最高得点出した時のスクショ。予選突破の閾値が36,471だからもう一つ二つできてたら、、 pic.twitter.com/K9pVmjahZj
&mdash; yudppp (@yudppp) 2018年9月16日 
ちなみに構成は 1号機: DB 2号機: H2O 3号機: app(Go) でした。
感想戦 あまりに悔しかったので予選の最高得点を超えれるよう1人で頑張ってみました。 個人的なルールとして今回はカンニング(他の参加者のブログを見ない)でやるようにしました。 ただしTwitterやDiscord等で受動的に入ってきてしまったものは見ています。
結果として 109,872 をだすことができ、一位通過の点数を越すことができたのでひと満足しています。(※実際の予選と同じスペックですが密集度が異なるためスコアが同一の水準に満たない場合があります)
主にアプリで追加でやったことは
 シートの予約時のロックをアプリで取るように変更 → これでFailが減った FOR UPDATEの除去 getEventsのreservationをまとめて取るように renderReportCSVのsortを削除  この辺りを触っていたところ4万点台は出るようになってきましたが、アプリが一台で辛くなってきました。またh2oのサーバーに余裕があったので /admin のアクセスだけh2oと同じサーバーで動かすようにしたところ7万点台になりました。
ベンチの結果を見ると
 レスポンスが遅いため負荷レベルを上げられませんでした。/admin/api/reports/sales
 だけとなっていて、このAPI自体はRDBを使っている以上どうしようもないところまできたので、マニュアルを見返して見た所、
 負荷走行中は、毎秒負荷レベルが増えていきます。 ただし、過去5秒以内に何らかのエラーが発生していた場合は負荷レベルが上昇しません。 終了時の負荷レベルや、負荷レベルが上がらない原因になったエラーについてはポータルサイトから確認することができます。
負荷走行後の確認へのレスポンスがそれぞれ下記の規定秒数以内に戻らない場合 POST /admin/api/actions/login: 20秒以内 GET /admin/api/reports/sales: 60秒以内">


  </head>
  <body class="hack">
    <header>
  <div class="container">
    
    <div class="nav">
      <div class="nav__left">
        <span class="nav__item">
          <a class="nocolor" href="https://blog.yudppp.com">
            <canvas class="mini-logo" width="150" height="50">
          </a>
        </span>
      </div>
    </div>
    <div class="title">
      <h1>ISUCON8の予選で敗戦した話と感想戦で1位の点数を超えるまで頑張った話</h1>
    </div>
    
  </div>
</header>

    <main>
      <div class="container">
        <date>2018.09.24</date>
        <div class="content">
          

<h2 id="当日">当日</h2>

<p>ISUCON8の予選に参加しました。ISUCON4から参加しているので5回目ですが、一度も決勝行けてないので辛いです。</p>

<p>今年もいつものメンバーで参加の予定だったのですが体調不良によって2人での参加になりました。</p>

<p>自分は当日メインでアプリを触りやったことのは</p>

<ul>
<li>User周りの不要なQuery削除</li>
<li>Sheetをオンメモリーにもつ</li>
<li>1000N + 1 だった <code>getEvents</code> を一旦 N + 1 に修正</li>
<li>reservationsに<code>user_id_idx</code>を追加</li>
<li>getEventSimpleというsheet情報だけをとるように一部切り替え</li>
</ul>

<p>この辺りを行い最高で<code>19,787</code>となりのあと1時間だったので夢を見たのですが、その後Failが続き色々検証しているうちに終了となりました。</p>

<p>reservationにRedisを使おうという考えもあったのですが時間考えると乗り出せませんでした。</p>

<p><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">今年のISUCON最高得点出した時のスクショ。予選突破の閾値が36,471だからもう一つ二つできてたら、、 <a href="https://t.co/K9pVmjahZj">pic.twitter.com/K9pVmjahZj</a></p>&mdash; yudppp (@yudppp) <a href="https://twitter.com/yudppp/status/1041272248038879233?ref_src=twsrc%5Etfw">2018年9月16日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>ちなみに構成は
1号機: DB
2号機: H2O
3号機: app(Go)
でした。</p>

<h2 id="感想戦">感想戦</h2>

<p>あまりに悔しかったので予選の最高得点を超えれるよう1人で頑張ってみました。
個人的なルールとして今回はカンニング(他の参加者のブログを見ない)でやるようにしました。
ただしTwitterやDiscord等で受動的に入ってきてしまったものは見ています。</p>

<p>結果として <code>109,872</code> をだすことができ、一位通過の点数を越すことができたのでひと満足しています。(※実際の予選と同じスペックですが密集度が異なるためスコアが同一の水準に満たない場合があります)</p>

<p>主にアプリで追加でやったことは</p>

<ul>
<li>シートの予約時のロックをアプリで取るように変更 → これでFailが減った</li>
<li>FOR UPDATEの除去</li>
<li><code>getEvents</code>のreservationをまとめて取るように</li>
<li>renderReportCSVのsortを削除</li>
</ul>

<p>この辺りを触っていたところ4万点台は出るようになってきましたが、アプリが一台で辛くなってきました。またh2oのサーバーに余裕があったので <code>/admin</code> のアクセスだけh2oと同じサーバーで動かすようにしたところ7万点台になりました。</p>

<p>ベンチの結果を見ると</p>

<blockquote>
<p>レスポンスが遅いため負荷レベルを上げられませんでした。/admin/api/reports/sales</p>
</blockquote>

<p>だけとなっていて、このAPI自体はRDBを使っている以上どうしようもないところまできたので、マニュアルを見返して見た所、</p>

<blockquote>
<p>負荷走行中は、毎秒負荷レベルが増えていきます。 ただし、過去5秒以内に何らかのエラーが発生していた場合は負荷レベルが上昇しません。 終了時の負荷レベルや、負荷レベルが上がらない原因になったエラーについてはポータルサイトから確認することができます。</p>

<p>負荷走行後の確認へのレスポンスがそれぞれ下記の規定秒数以内に戻らない場合
POST /admin/api/actions/login: 20秒以内
GET /admin/api/reports/sales: 60秒以内</p>
</blockquote>

<p>の二つのルールに着目すると、レスポンスが遅い結果負荷レベルが上がらず、点数が上がらないといった感じでした。
そこで <code>/admin/api/reports/sale</code> に <code>time.Sleep(50 * time.Seconds)</code>を入れたところ負荷レベルが上がるようになり点数が増えて行きました。
Sleep時間を調整していった結果15秒Sleepさせた時に <code>109,872</code> となり最高得点となりました。</p>

<p>source: <a href="https://gist.github.com/yudppp/9cfee2009e220923218719e020271b82">https://gist.github.com/yudppp/9cfee2009e220923218719e020271b82</a></p>

          <a href="https://twitter.com/share" class="twitter-share-button" data-via="yudppp">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-noballoon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
          <div class="comment">
    <div>
        <a id="js-open-comment" class="event">
            show comment <span class="disqus-comment-count" data-disqus-url="https://blog.yudppp.com/posts/isucon2018/"></span>
        </a>
    </div>
    <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
     
     
    var openDiqus = function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//yudppp.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    document.all("js-open-comment").style.display = "none";
    };
    document.getElementById("js-open-comment").addEventListener('click',openDiqus,false);
</script>
        </div>
      </div>
    </main>
    
<div class="container">
	<div class="prevnext">
		
		<a class="pull-left" href="https://blog.yudppp.com/posts/commoninitialisms/">
			<div>&lt;&lt; I made get commonInitialisms library(Using go/ast)</div>
		</a>
		
		
		<a class="pull-right" href="https://blog.yudppp.com/posts/create_sendgrid_mock/">
			<div>SendGridを開発環境やテスト環境で上手に使う &gt;&gt;</div>
		</a>
		
	</div>
</div>

    <div class="container">
  <a href="https://blog.yudppp.com/posts/whoami/">
    <div class="media profile">
      <div class="media-left">
        <img class="avatarholder" src="https://blog.yudppp.com/img/profile.svg" />
      </div>
      <div class="media-body">
        <div class="media-heading">@yudppp</div>
        <div class="media-content">Web engineer.</div>
      </div>
    </div>
  </a>
</div>

    <script src="https://blog.yudppp.com/js/lib.min.js"></script>
<script src="https://blog.yudppp.com/js/app.min.js"></script>
<script id="dsq-count-scr" src="//yudppp.disqus.com/count.js" async></script>
  </body>
</html>
